<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="base::layout('Counter-in Details', ~{::section})">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Counter-in Details</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

</head>

<section>
    <audio id="errorSound" th:src="@{/mp3/Pricebook_not_found.mp3}" preload="auto"></audio>
    <div th:replace="/utill/MessageShow.html :: toast"></div>
    <div class="container-fluid mt-5">
        <p id="resultMessage" class="mt-4 font-medium text-center"></p>
        <div class="card shadow rounded-lg w-100 mx-auto">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Counter-in Details</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">View counter-in data filtered by date.</p>

                <!-- Filter Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <label for="barcodeSearchInput" class="form-label"><strong>Scan Barcode for
                                Sale.</strong></label>
                        <input type="text" id="barcodeSearchInput" name="barcodeSearchInput"
                            placeholder="Scan barcode for Sale Item." class="form-control" autofocus>
                    </div>
                </div>
                <div class="row my-4 align-items-end">
                    <div class="col-md-3 mb-3">
                        <label for="startDateFilter" class="form-label fw-bold">Start Date</label>
                        <input type="date" class="form-control" id="startDateFilter">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="endDateFilter" class="form-label fw-bold">End Date</label>
                        <input type="date" class="form-control" id="endDateFilter">
                    </div>
                    <div class="col-md-2 mb-3">
                        <button class="btn btn-primary w-100" id="getSaleDetail">Get Details</button>
                    </div>
                </div>

                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-primary fs-6" id="totalSaleAmount"></span>
                    <span class="badge bg-success fs-6" id="totalRecordCount"></span>
                </div>

                <!-- Sales Table -->
                <div class="table-responsive rounded-lg shadow-sm border">
                    <table class="table table-bordered table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="py-3 px-4 text-start text-uppercase tracking-wider w-25">Product Info</th>
                                <th class="py-3 px-4 text-center text-uppercase tracking-wider">Total Quantity</th>
                                <th class="py-3 px-4 text-center text-uppercase tracking-wider">Total Volume (ML)</th>
                                <th class="py-3 px-4 text-center text-uppercase tracking-wider">Total Sales (INR)</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable"></tbody>
                    </table>
                </div>

                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content rounded-lg">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="confirmModalLabel">Confirmation Required</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="confirmMessage">Are you sure you want to perform this action?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary rounded-lg"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger rounded-lg"
                                    id="confirmActionBtn">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center py-5 text-muted d-none">
                    <p>Loading sales data...</p>
                </div>
            </div>
        </div>
    </div>

    <div style="visibility: hidden;">
        <p id="loggedUserRoleName" th:text="${session.sessionObj.role}"></p>

        <input type="date" id="currentSaleDate" name="currentSaleDate" class="form-control" required>
    </div>
    <script>


        document.addEventListener('DOMContentLoaded', () => {
            //const monthFilter = document.getElementById('monthFilter');

            const dateFilter = document.getElementById('startDateFilter');
            const salesTableBody = document.getElementById('salesTable');
            const loadingIndicator = document.getElementById('loadingIndicator');
            let totalSaleAmountEl = document.getElementById('totalSaleAmount');
            let totalRecordCountEl = document.getElementById('totalRecordCount');
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const confirmMessageEl = document.getElementById('confirmMessage');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            // const showModalBtn = document.getElementById('showModalBtn');
            const resultMessageEl = document.getElementById('resultMessage');
            const barcodeSearchInput = document.getElementById('barcodeSearchInput');
            const endDateInput = document.getElementById('endDateFilter');
            const roleName = document.getElementById("loggedUserRoleName").textContent;
            console.log('role value ' + roleName)
            // New modal and input elements for the barcode scanner
            document.addEventListener("click", () => {
                barcodeSearchInput.focus()
            });


            dateFilter.value = new Date();
            let saleId;
            let saleItemId;

            const hasActionColumn = document.querySelector('th[scope="col"]:last-child') &&
                document.querySelector('th[scope="col"]:last-child').textContent.trim() === 'Action';

            // --- DEBOUNCE FUNCTION ---
            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }
            // This function simulates fetching data from a backend API
            async function fetchSalesData(month, date) {
                console.log('----------calling featch ')
                // In a real application, you would make a fetch call here:
                // const response = await fetch(`/api/sales?month=${month}&date=${date}`);
                // const data = await response.json();
                if (date) {
                    let dateParts = date.split('-');
                    let monthNumber = parseInt(dateParts[1]); // 8
                    let dayNumber = parseInt(dateParts[2]);
                    const filterDate = dateParts[0] + "-" + monthNumber + "-" + dayNumber;

                    const response = await fetch(`/sale/details/end-date?endDate=${endDateInput.value || ''}`)
                    const data_x = await response.json();
                    console.log('VVV ' + JSON.stringify(data_x))


                    renderTable(groupCounterInItem(data_x));
                    //console.log('data_xdata_xdata_x'+ JSON.stringify(data_x))
                }

            }


            function groupCounterInItem(sales) {
                let totalCounterInVol = 0;
                const grouped = sales.reduce((acc, sale) => {
                    sale.items.forEach(item => {
                        const key = item.productName;

                        if (!acc[key]) {
                            acc[key] = {
                                productInfo: key,
                                totalQuantity: 0,
                                totalVolmue: 0,
                                totalSales: 0,
                                salesDetails: []
                            };
                        }
                        totalCounterInVol += item.volumnML;
                        acc[key].totalVolmue += item.volumnML;
                        acc[key].totalQuantity += item.quantitySold;
                        acc[key].totalSales += item.unitPriceAtSale * item.quantitySold;
                        acc[key].salesDetails.push({
                            saleId: sale.saleId,
                            saleItemId: item.saleItemId,
                            saleDate: sale.saleDate,
                            quantity: item.quantitySold,
                            price: item.unitPriceAtSale
                        });
                    });

                    return acc;
                }, {});

                // Convert object â†’ array (optional)
                const result = Object.values(grouped);
                console.log('resultresultresult ============== ' + JSON.stringify(result))
                return result;
            }

            function renderTable(data) {
                salesTableBody.innerHTML = '';
                if (data.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="4" class="text-center text-muted">No sales data available.</td>`;
                    salesTableBody.appendChild(noDataRow);
                    totalSaleAmountEl.textContent = 'Total Sales: 0';
                    totalRecordCountEl.textContent = 'Total Items: 0';
                    return;
                }

                let totalSales = 0;
                let totalItems = 0;
                data.forEach((group, i) => {
                    totalSales += group.totalSales;
                    totalItems += group.totalQuantity;

                    const parentRow = document.createElement("tr");
                    parentRow.className = "table-light cursor-pointer";
                    parentRow.onclick = () => toggleChildren(i, parentRow);

                    parentRow.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-sm fw-bold text-gray-900">
                        <i class="fas fa-plus me-2 text-muted"></i> ${group.productInfo}
                    </td>
                    <td class="py-3 px-4 text-center text-sm text-gray-500">${group.totalQuantity}</td>
                    <td class="py-3 px-4 text-center text-sm text-gray-500">${group.totalVolmue}</td>
                    <td class="py-3 px-4 text-center text-sm text-gray-500">${group.totalSales}</td>
                `;
                    salesTableBody.appendChild(parentRow);

                    const childRow = document.createElement("tr");
                    childRow.id = `child-of-${i}`;
                    childRow.className = "child-row bg-white";

                    const colspan = 4;
                    childRow.innerHTML = `
                    <td colspan="${colspan}" class="py-4 px-4">
                        <div class="ps-5">
                            <h6 class="fw-bold text-secondary mb-2">Sale Details:</h6>
                            <div class="table-responsive border rounded">
                                <table class="table table-sm mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="py-2 px-4 text-start">Sale ID</th>
                                            <th class="py-2 px-4 text-start">Sale Date</th>
                                            <th class="py-2 px-4 text-start">Quantity</th>
                                            <th class="py-2 px-4 text-start">Price</th>
                                            ${roleName === 'ADMIN' ? ` <th class="py-2 px-4 text-start">Action</th>`
                            : ''}
                                           
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.salesDetails.map(detail => `
                                            <tr class="table-row-hover">
                                                <td class="py-2 px-4">${detail.saleId}</td>
                                                <td class="py-2 px-4">${detail.saleDate}</td>
                                                <td class="py-2 px-4">${detail.quantity}</td>
                                                <td class="py-2 px-4">${detail.price}</td>
                                                
                                                ${roleName === 'ADMIN' ?

                                    `<td class="py-2 px-4"> <button class="btn btn-danger btn-sm" onclick="deleteSaleItem(${detail.saleId}, ${detail.saleItemId})">
                                                        <i class="fas fa-trash-alt"></i> Delete
                                                    </button>  </td>`
                                    : ''}
                                                    
                                               
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                `;
                    salesTableBody.appendChild(childRow);
                });

                totalSaleAmountEl.textContent = `Total Sales: ${totalSales.toFixed(2)} INR`;
                totalRecordCountEl.textContent = `Total Items: ${totalItems}`;
            }

            function toggleChildren(index, parentRow) {
                const childRow = document.getElementById(`child-of-${index}`);
                const icon = parentRow.querySelector('i');

                if (childRow.style.display === "table-row") {
                    childRow.style.display = "none";
                    icon.classList.remove('fa-minus');
                    icon.classList.add('fa-plus');
                } else {
                    childRow.style.display = "table-row";
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-minus');
                }
            }

            async function filterSalesData() {
                loadingIndicator.classList.remove('d-none');

                //const monthValue = monthFilter.value;
                const dateValue = dateFilter.value;
                console.log('dateValue value is  ' + dateValue)
                try {
                    fetchSalesData(null, dateValue);
                    //renderSalesData(filteredSales);
                } catch (error) {
                    console.error("Error fetching sales data:", error);
                    salesTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load sales data.</td></tr>';
                } finally {
                    loadingIndicator.classList.add('d-none');
                }
            }



            document.getElementById("getSaleDetail").addEventListener('click', async () => {
                console.log('endDateInput ' + endDateInput.value)
                if (dateFilter.value && endDateInput.value) {
                    const response = await fetch(`/sale/details/date?date=${dateFilter.value}&endDate=${endDateInput.value}`)
                    const data_x = await response.json();
                    renderTable(groupCounterInItem(data_x));
                } else {
                    showToast("Start/End Date missing..", "Please select start date and End date for search.", "warning")
                }
            })


            window.deleteSaleItem = function (id, itemId) {
                saleId = id;
                saleItemId = itemId;
                console.log('deleteSaleItem  ' + id + " itemId " + itemId)
                showDeleteModal(id, itemId)
            }

            // Show and handle the custom confirmation modal
            function showDeleteModal(saleId, saleItemId) {
                showConfirmModal(
                    "Are you sure you want to delete this Sale-Item? This action cannot be undone.",
                    () => {
                        // This is the function that runs on confirmation.
                        console.log("User deletion confirmed!");
                    }
                );
            }

            function showConfirmModal(message, callback) {
                confirmMessageEl.textContent = message;
                confirmationCallback = callback;
                confirmModal.show();
            }

            // Event listener for the "Confirm" button inside the modal
            confirmActionBtn.addEventListener('click', () => {
                if (confirmationCallback) {
                    handleDeleteSale();
                }
                confirmModal.hide();
            });



            async function handleDeleteSale() {
                console.log('---SaleId--> ' + saleId + ' ----itemId ' + saleItemId);
                if (saleId == null || saleItemId == null) return;

                try {
                    const response = await fetch(`/sale/delete/${parseInt(saleId)}/items/${parseInt(saleItemId)}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        resultMessageEl.textContent = "Action Confirmed: Sale-Item has been deleted.";
                        resultMessageEl.className = "mt-4 font-semibold text-green-600";
                        const dateFilter = document.getElementById('startDateFilter');
                        fetchSalesData(null, dateFilter.value);
                    } else {
                        // alert("Failed to delete the sale. You may not have the necessary permissions.");
                        console.error("Delete failed with status:", response.status);
                    }
                } catch (error) {
                    console.error("Error during delete operation:", error);
                    // alert("An error occurred. Please try again.");
                }

            }

            dateFilter.addEventListener('change', () => {
                console.log("---------------------------------")
                // monthFilter.value = ''; // Clear month filter when date changes
                filterSalesData();
            });


            // --- New Logic: Search by Price Book Barcode ---
            const handleBarcodeSearch = async () => {
                const barcode = barcodeSearchInput.value.trim();
                const currentDate = document.getElementById('currentSaleDate').value;
                if (barcode.length >= 4) {
                    console.log('barcode ---> ' + barcode + ' currentDate ' + currentDate)
                    try {
                        const response = await fetch(`/sale/api/save/barcode/${barcode}/saledate/${currentDate}`, { method: 'POST' });
                        if (response.ok) {
                            const responseJSON = await response.json();
                            if (responseJSON != null && responseJSON.message == 'success') {
                                showToast('Success', 'Sale successfully save.', 'success')
                                filterSalesData();
                                barcodeSearchInput.value = ''; // Clear the barcode input
                                barcodeSearchInput.focus(); // Keep focus on the barcode input for the next item
                            } else {
                                document.getElementById("errorSound").play();
                                showToast('Pricebook not found', responseJSON.message, 'warning');
                                barcodeSearchInput.value = ''; // Clear the barcode input
                                barcodeSearchInput.focus();
                            }
                        }
                    } catch (error) {
                        console.error('Network error:', error);
                    }
                }
            };

            // Use the debounced function for the 'input' event (typing)
            const debouncedBarcodeSearch = debounce(handleBarcodeSearch, 500);

            barcodeSearchInput.addEventListener('input', debouncedBarcodeSearch);
            // ------------------------------------------------------------------
            // New Logic: Set the date filter to today's date and load data on page load
            // ------------------------------------------------------------------
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // Set the date input value to today's date
            dateFilter.value = formattedDate;
            endDateInput.value = formattedDate;
            document.getElementById('currentSaleDate').value = formattedDate;
            filterSalesData();


            function showToast(title, message, type = "primary") {
                // Get toast elements
                const toastEl = document.getElementById("basicToast");
                const toastTitle = document.getElementById("myToastTitle");
                const toastMessage = document.getElementById("myToastMessage");
                const header = toastEl.querySelector(".toast-header");

                // Set values
                toastTitle.textContent = title;
                toastMessage.textContent = message;

                // Update color (Bootstrap contextual classes)
                header.className = `toast-header bg-${type} text-light`;

                // Show toast
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });



    </script>
</section>