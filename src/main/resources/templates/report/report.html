<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org" th:replace="base::layout('Report', ~{::section})">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Sale Detail</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

</head>

<section>
    <div class="container">
        <div class="container mt-5">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-chart-line"></i> Purchase & Sales Report</h3>
                </div>
                <div class="card-body">
                    <!-- Date Range Selection -->
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="reportType">Report Type</label>
                            <select id="reportType" class="form-control">
                                <option value="sale">Sale</option>
                                <option value="purchase">Purchase</option>
                            </select>
                        </div>
                        <div class="form-group  mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select id="category" class="form-select" name="category.id" required>
                                <option value="">Select a category</option>
                                <!-- Thymeleaf can pre-populate all categories here from the controller -->
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="startDate">Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="endDate">End Date</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center mt-3">
                        <button id="generateReportBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-file-excel mr-2"></i> Download Report (Excel)
                        </button>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loadingSpinner" class="text-center mt-4 loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Generating report...</p>
                    </div>

                    <!-- Report Display Section (hidden by default) -->
                    <div id="reportDisplayArea" class="mt-5" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th scope="col">Product Name</th>
                                        <th scope="col" class="text-right">Total Quantity</th>
                                        <th scope="col" class="text-right">Total Sale Price</th>
                                        <th scope="col" class="text-right">Total Volume (ml)</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-table-body">
                                    <!-- Data will be rendered here if you decide to show it on screen -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>

            document.addEventListener('DOMContentLoaded', () => {
                const loadingIndicator = document.getElementById('loadingSpinner');
                loadingIndicator.style.display = 'none';
                const categorySelect = document.getElementById('category');
                let categoryValue = '';
                document.getElementById('generateReportBtn').addEventListener('click', async function () {
                    // Get the date values from the input fields
                    const reportType = document.getElementById('reportType').value;
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    const generateButton = document.getElementById('generateReportBtn');
                    

                    // Basic validation
                    if (!startDate || !endDate) {
                        // IMPORTANT: Use a custom modal instead of alert() in production.
                        // For this example, we use it for simplicity.
                        alert('Please select both a start and end date.');
                        return;
                    }

                    // Disable button and show loading spinner
                    generateButton.disabled = true;
                    loadingIndicator.style.display = 'block';

                    // Construct the URL with query parameters
                    const apiUrl = `/api/report/${reportType == 'sale' ? 'sale' : 'purchase'}/details?startDate=${startDate}&endDate=${endDate}&categoryId=${categoryValue}`;

                    try {
                        // Use the fetch API to make a GET request to your backend endpoint
                        const response = await fetch(apiUrl);
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        const reportData = await response.json();

                        // Check if the data is valid
                        if (!reportData || reportData.length === 0) {
                            alert('No data found for the selected date range.');
                            return;
                        }
                        console.log('reportdata ' + JSON.stringify(reportData))
                        if (reportType == 'sale') {
                            buildSaleReport(reportData, startDate, endDate)
                        } else {
                            buildPurchaseReport(reportData, startDate, endDate);
                        }

                    } catch (error) {
                        // Handle any errors that occurred during the fetch or conversion
                        console.error('Failed to fetch or generate report:', error);
                        alert('An error occurred while generating the report. Please check the console for details.');
                    } finally {
                        // Re-enable the button and hide the loading spinner
                        generateButton.disabled = false;
                        loadingIndicator.style.display = 'none';
                    }
                });

                //handle Category selection

                // Event listener for Category dropdown change
                categorySelect.addEventListener('change', (event) => {
                    categoryValue = event.target.value;
                    console.log('categoryValue '+ categoryValue)
                });


                function buildSaleReport(reportData, startDate, endDate) {
                    console.log('sale report calling...... ' + JSON.stringify(reportData))
                    // 1. Create a new worksheet from the JSON data.
                    // The 'header' option ensures the key names become the column headers.
                    const worksheet = XLSX.utils.json_to_sheet(reportData, {
                        header: ["saleDate", "categoryName", "productName", "unitPrice", "totalQuantity", "totalSalePrice", "totalVolume"]
                    });

                    // 2. Override the default headers with user-friendly names.
                    // This is an optional step to make the Excel file more readable.
                    XLSX.utils.sheet_add_aoa(worksheet, [
                        ["Date of Sale", "Category", "Product Name", "Unit Price", "Total Quantity", "Total Sale Price", "Total Volume (ml)"]
                    ], { origin: "A1" });

                    // 3. Create a new workbook and add the worksheet to it.
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Sales Report");

                    // 4. Trigger the download using the write function.
                    const fileName = `sales_report_${startDate}_to_${endDate}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                }

                function buildPurchaseReport(reportData, startDate, endDate) {
                    console.log('purchase report calling......')
                    // 1. Create a new worksheet from the JSON data.
                    // The 'header' option ensures the key names become the column headers.
                    const worksheet = XLSX.utils.json_to_sheet(reportData, {
                        header: ["dateOfPurchase", "categoryName", "productName", "unitPrice", "totalQuantity", "totaPurchasePrice", "totalVolume"]
                    });

                    // 2. Override the default headers with user-friendly names.
                    // This is an optional step to make the Excel file more readable.
                    XLSX.utils.sheet_add_aoa(worksheet, [
                        ["Date of Purchase",  "Category", "Product Name", "Unit Pirice", "Total Quantity", "Total Purchase Price", "Total Volume (ml)"]
                    ], { origin: "A1" });

                    // 3. Create a new workbook and add the worksheet to it.
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Purchase Report");

                    // 4. Trigger the download using the write function.
                    const fileName = `purchase_report_${startDate}_to_${endDate}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                }
            })

        </script>
</section>